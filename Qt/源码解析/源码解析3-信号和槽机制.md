# Qt源码解析 [索引](https://blog.csdn.net/xinqingwuji/article/details/118365888)

# Qt源码解析2---

# WinMain 函数 (winbase.h)

- 用程序的入口点。

**WinMain**是用于应用程序入口点的常规名称。

## 句法

C++复制

```cpp
int __clrcall WinMain(
  [in] HINSTANCE hInstance,
  [in] HINSTANCE hPrevInstance,
  [in] LPSTR     lpCmdLine,
  [in] int       nShowCmd
);
```

## 参数

```
[in] hInstance
```

类型：**HINSTANCE**

应用程序当前实例的句柄。

```
[in] hPrevInstance
```

类型：**HINSTANCE**

应用程序前一个实例的句柄。此参数始终为**NULL**。如果您需要检测另一个实例是否已经存在，请使用[CreateMutex](https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-createmutexa)函数创建一个唯一命名的互斥锁。即使互斥锁已经存在，**CreateMutex**也会成功，但函数会返回**ERROR_ALREADY_EXISTS**. 这表明您的应用程序的另一个实例存在，因为它首先创建了互斥锁。但是，恶意用户可以在您之前创建此互斥锁并阻止您的应用程序启动。为防止出现这种情况，请创建一个随机命名的互斥锁并存储该名称，以便只能由授权用户获取。或者，您可以为此目的使用文件。要将您的应用程序限制为每个用户一个实例，请在用户的配置文件目录中创建一个锁定文件。

```
[in] lpCmdLine
```

类型：**LPSTR**

应用程序的命令行，不包括程序名称。要检索整个命令行，请使用[GetCommandLine](https://docs.microsoft.com/en-us/windows/desktop/api/processenv/nf-processenv-getcommandlinea)函数。

```
[in] nShowCmd
```

类型：**int**

控制窗口的显示方式。此参数可以是可以在[ShowWindow](https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-showwindow)函数的*nCmdShow*参数中指定的任何值。

## 返回值

类型：**int**

如果函数成功，当它接收到[WM_QUIT](https://docs.microsoft.com/en-us/windows/desktop/winmsg/wm-quit)消息时终止，它应该返回包含在该消息的*wParam*参数中的退出值。如果函数在进入消息循环之前终止，它应该返回零。

## 评论

许多编程框架按照惯例使用名称**WinMain**。根据编程框架，可以在调用**WinMain**函数之前和之后执行特定于该框架的附加活动。

您的**WinMain**应该初始化应用程序，显示其主窗口，并进入一个消息检索和分发循环，这是应用程序执行剩余部分的顶级控制结构。当它收到[WM_QUIT](https://docs.microsoft.com/en-us/windows/desktop/winmsg/wm-quit)消息时终止消息循环。此时，您的**WinMain**应该退出应用程序，返回在**WM_QUIT**消息的*wParam*参数中传递的值。如果作为调用[PostQuitMessage](https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-postquitmessage)的结果接收到**WM_QUIT**，则*wParam*的值是**PostQuitMessage**函数的*nExitCode*参数的值。有关更多信息，请参阅[创建消息循环](https://docs.microsoft.com/en-us/windows/desktop/winmsg/using-messages-and-message-queues)。

ANSI 应用程序可以使用**WinMain**函数的*lpCmdLine*参数来访问命令行字符串，不包括程序名称。请注意，*lpCmdLine*使用**LPSTR**数据类型而不是**LPTSTR**数据类型。这意味着**WinMain**不能被 Unicode 程序使用。该[GetCommandLineW](https://docs.microsoft.com/en-us/windows/desktop/api/processenv/nf-processenv-getcommandlinea)函数可以被用来获取命令行作为Unicode字符串。某些编程框架可能会提供一个替代入口点来提供 Unicode 命令行。例如，Microsoft Visual Studio C++ 编译器使用名称**wWinMain**作为 Unicode 入口点。

## 例子

下面的代码示例演示了**WinMain**的使用

```cpp
#include <windows.h>

int APIENTRY WinMain(HINSTANCE hInst, HINSTANCE hInstPrev, PSTR cmdline, int cmdshow)
{
    return MessageBox(NULL, "hello, world", "caption", 0);
}
```